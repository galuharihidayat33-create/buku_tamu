<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Buku Tamu Digital – QR (HP & PC)</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { display: ['"Playfair Display"', 'serif'], body: ['Inter', 'system-ui', 'sans-serif'] },
          colors: { brand: { 50: '#eef6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' } },
          boxShadow: { glass: '0 22px 70px rgba(22,40,80,.18)' },
          keyframes: {
            fadeUp: { '0%':{opacity:0, transform:'translateY(10px)'}, '100%':{opacity:1, transform:'translateY(0)'} },
            pop: { '0%':{transform:'scale(.98)'}, '100%':{transform:'scale(1)'} }
          },
          animation: { 'fade-up': 'fadeUp .8s ease-out both', pop: 'pop .15s ease-out both' }
        }
      }
    }
  </script>
  <!-- QR Scanner & Generator Libraries -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    /* Make iOS Safari fullscreen look nicer */
    html, body { height: 100%; background: linear-gradient(180deg,#f8fafc,#eef6ff); }
    .glass { background: rgba(255,255,255,.86); backdrop-filter: blur(10px); }
  </style>
</head>
<body class="font-body text-slate-700">
  <main class="min-h-screen max-w-5xl mx-auto px-4 py-6 md:py-10">
    <!-- Header -->
    <header class="flex items-center justify-between gap-3 mb-5 md:mb-8">
      <div>
        <h1 class="font-display text-2xl md:text-3xl text-brand-800">Buku Tamu Digital</h1>
        <p class="text-sm text-slate-500">Scan QR • Mobile & Desktop • Ekspor CSV</p>
      </div>
      <a href="#panduan" class="text-brand-700 hover:underline text-sm">Panduan</a>
    </header>

    <!-- Top Controls -->
    <section class="glass rounded-2xl shadow-glass p-4 md:p-6 mb-6 animate-fade-up">
      <div class="grid md:grid-cols-4 gap-3">
        <label class="block">
          <span class="text-xs text-slate-500">ID Acara</span>
          <input id="eventId" class="w-full mt-1 px-3 py-2 rounded-xl ring-1 ring-slate-200 focus:ring-brand-400 outline-none" placeholder="cth: WEDD-2025-ANDIN-DAFA" />
        </label>
        <label class="block">
          <span class="text-xs text-slate-500">Nama Operator</span>
          <input id="operatorName" class="w-full mt-1 px-3 py-2 rounded-xl ring-1 ring-slate-200 focus:ring-brand-400 outline-none" placeholder="cth: Resepsionis 1" />
        </label>
        <label class="block">
          <span class="text-xs text-slate-500">Lokasi/Meja (opsional)</span>
          <input id="station" class="w-full mt-1 px-3 py-2 rounded-xl ring-1 ring-slate-200 focus:ring-brand-400 outline-none" placeholder="cth: Meja A" />
        </label>
        <div class="flex items-end gap-2">
          <button id="startScanBtn" class="flex-1 px-4 py-2 rounded-xl bg-brand-600 text-white hover:bg-brand-700 active:scale-[.99]">Mulai Scan</button>
          <button id="stopScanBtn" class="px-4 py-2 rounded-xl ring-1 ring-slate-200 text-slate-600 hover:bg-slate-50">Stop</button>
        </div>
      </div>
      <p class="mt-2 text-xs text-slate-500">Tips: Gunakan <span class="font-medium">kamera belakang</span> di HP. Di desktop, izinkan akses kamera. HTTPS diperlukan untuk akses kamera di sebagian besar browser.</p>
    </section>

    <!-- Scanner + Manual Entry -->
    <section class="grid md:grid-cols-2 gap-6">
      <!-- Scanner Card -->
      <article class="glass rounded-2xl shadow-glass p-4 md:p-6 animate-fade-up">
        <h2 class="font-display text-lg text-brand-800 mb-3">Scanner QR</h2>
        <div id="qr-reader" class="rounded-xl overflow-hidden ring-1 ring-slate-200"></div>
        <p id=\"scanHint\"$1</p>
        <p id=\"permWarn\" class=\"text-xs mt-2 text-red-600 hidden\"></p>
      </article>

      <!-- Manual Entry Card -->
      <article class="glass rounded-2xl shadow-glass p-4 md:p-6 animate-fade-up">
        <h2 class="font-display text-lg text-brand-800 mb-3">Input Manual / Koreksi</h2>
        <div class="grid grid-cols-2 gap-3">
          <label class="block col-span-2">
            <span class="text-xs text-slate-500">Nama Tamu</span>
            <input id="m_name" class="w-full mt-1 px-3 py-2 rounded-xl ring-1 ring-slate-200 focus:ring-brand-400 outline-none" placeholder="cth: Bpk/Ibu Ahmad" />
          </label>
          <label class="block">
            <span class="text-xs text-slate-500">Kode Tiket / QR</span>
            <input id="m_code" class="w-full mt-1 px-3 py-2 rounded-xl ring-1 ring-slate-200 focus:ring-brand-400 outline-none" placeholder="cth: INV-0001" />
          </label>
          <label class="block">
            <span class="text-xs text-slate-500">Jumlah Tamu</span>
            <input id="m_qty" type="number" min="1" value="1" class="w-full mt-1 px-3 py-2 rounded-xl ring-1 ring-slate-200 focus:ring-brand-400 outline-none" />
          </label>
        </div>
        <div class="mt-3 flex gap-2">
          <button id="saveManual" class="px-4 py-2 rounded-xl bg-brand-600 text-white hover:bg-brand-700">Simpan</button>
          <button id="clearManual" class="px-4 py-2 rounded-xl ring-1 ring-slate-200 text-slate-600">Bersihkan</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">Gunakan jika QR sulit terbaca atau perlu mengubah data hasil scan.</p>
      </article>
    </section>

    <!-- Stats + Actions -->
    <section class="grid md:grid-cols-3 gap-6 mt-6">
      <div class="glass rounded-2xl shadow-glass p-4 md:p-6 animate-fade-up">
        <div class="text-sm text-slate-500">Total Check-in</div>
        <div id="statTotal" class="text-3xl font-display text-brand-800">0</div>
        <div id="statLast" class="text-xs text-slate-500 mt-1">Terakhir: —</div>
      </div>
      <div class="glass rounded-2xl shadow-glass p-4 md:p-6 animate-fade-up">
        <div class="text-sm text-slate-500">Filter Pencarian</div>
        <input id="searchInput" class="w-full mt-2 px-3 py-2 rounded-xl ring-1 ring-slate-200 focus:ring-brand-400 outline-none" placeholder="Cari nama/kode…" />
        <p class="text-xs text-slate-500 mt-1">Tekan <span class="font-mono">Enter</span> untuk menerapkan.</p>
      </div>
      <div class="glass rounded-2xl shadow-glass p-4 md:p-6 flex flex-wrap gap-2 items-end animate-fade-up">
        <button id="exportCsv" class="px-4 py-2 rounded-xl bg-brand-600 text-white hover:bg-brand-700">Ekspor CSV</button>
        <button id="resetData" class="px-4 py-2 rounded-xl ring-1 ring-red-200 text-red-600 hover:bg-red-50">Bersihkan Data (Event Ini)</button>
      </div>
    </section>

    <!-- Table -->
    <section class="glass rounded-2xl shadow-glass p-2 md:p-4 mt-6 animate-fade-up">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-slate-50">
              <th class="text-left px-3 py-2">#</th>
              <th class="text-left px-3 py-2">Waktu</th>
              <th class="text-left px-3 py-2">Nama</th>
              <th class="text-left px-3 py-2">Kode</th>
              <th class="text-left px-3 py-2">Jumlah</th>
              <th class="text-left px-3 py-2">Operator</th>
              <th class="text-left px-3 py-2">Lokasi</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <!-- QR Generator -->
    <section class="glass rounded-2xl shadow-glass p-4 md:p-6 mt-6 animate-fade-up">
      <h2 class="font-display text-lg text-brand-800 mb-3">Generator QR (untuk undangan/gelang)</h2>
      <div class="grid md:grid-cols-5 gap-3 items-end">
        <label class="block md:col-span-2">
          <span class="text-xs text-slate-500">Nama Tamu</span>
          <input id="g_name" class="w-full mt-1 px-3 py-2 rounded-xl ring-1 ring-slate-200 focus:ring-brand-400 outline-none" placeholder="cth: Ibu Sari" />
        </label>
        <label class="block">
          <span class="text-xs text-slate-500">Kode</span>
          <input id="g_code" class="w-full mt-1 px-3 py-2 rounded-xl ring-1 ring-slate-200 focus:ring-brand-400 outline-none" placeholder="cth: INV-0029" />
        </label>
        <label class="block">
          <span class="text-xs text-slate-500">ID Acara</span>
          <input id="g_event" class="w-full mt-1 px-3 py-2 rounded-xl ring-1 ring-slate-200 focus:ring-brand-400 outline-none" placeholder="cth: WEDD-2025-…" />
        </label>
        <div class="block">
          <span class="text-xs text-slate-500">Format</span>
          <select id="g_format" class="w-full mt-1 px-3 py-2 rounded-xl ring-1 ring-slate-200 focus:ring-brand-400 outline-none">
            <option value="pipe">EVT|NAMA|KODE</option>
            <option value="json">JSON {name,code,event}</option>
          </select>
        </div>
      </div>
      <div class="mt-3 flex gap-2 items-center">
        <button id="genQrBtn" class="px-4 py-2 rounded-xl bg-brand-600 text-white hover:bg-brand-700">Buat QR</button>
        <a id="downloadQr" class="hidden px-4 py-2 rounded-xl ring-1 ring-slate-200 text-slate-600" download>Unduh PNG</a>
      </div>
      <canvas id="qrCanvas" class="mt-4 hidden bg-white rounded-xl p-3"></canvas>
      <p class="text-xs text-slate-500 mt-2">Tempelkan QR pada undangan/gelang. Disarankan ukuran minimal 2.5 cm untuk hasil scan stabil.</p>
    </section>

    <!-- Panduan Ringkas -->
    <section id="panduan" class="mt-10">
      <h2 class="font-display text-lg text-brand-800 mb-2">Panduan Singkat</h2>
      <ol class="list-decimal pl-5 text-sm space-y-1 text-slate-600">
        <li>Isi <b>ID Acara</b>, <b>Nama Operator</b>, dan (opsional) <b>Lokasi/Meja</b>.</li>
        <li>Klik <b>Mulai Scan</b> lalu izinkan akses kamera. Arahkan ke QR tamu.</li>
        <li>Jika berhasil, data tampil otomatis dan tersimpan <i>local</i> di perangkat (persisten). Gunakan <b>Input Manual</b> bila perlu.</li>
        <li>Gunakan <b>Ekspor CSV</b> untuk rekap ke Excel/Google Sheets.</li>
        <li>Gunakan <b>Generator QR</b> untuk membuat QR bagi undangan.</li>
      </ol>
      <p class="text-xs text-slate-500 mt-2">Catatan: Versi ini <u>tanpa server</u>. Jika butuh sinkron multi-perangkat realtime, saya bisa bantu upgrade ke backend (mis. Supabase/Cloudflare D1) tanpa ubah UI.</p>
    </section>
  </main>

  <!-- Tiny beep as Base64 (no external files) -->
  <audio id="beep" preload="auto" class="hidden">
    <source src="data:audio/wav;base64,UklGRoQAAABXQVZFZm10IBIAAAABAAEAESsAACJWAAACABYBHG1hZGUgd2l0aCBhdWRpb3JlYWN0b3IAAABJTEBBAAAAPwAAAP//f39/AAAAAP//f39/AAAAAP//f39/AAAAAP//f39/AAAAAP//f39/AAAA" type="audio/wav">
  </audio>

  <script>
    // ----------------------------
    // Simple Local DB (per Event)
    // ----------------------------
    const DB_KEY = 'guestbook_v1';
    const $ = (sel) => document.querySelector(sel);
    const pad2 = (n) => String(n).padStart(2,'0');
    const nowStr = () => { const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}` };

    function loadDB(){ try { return JSON.parse(localStorage.getItem(DB_KEY)||'{}'); } catch { return {}; } }
    function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    function getEventId(){ return $('#eventId').value.trim() || 'DEFAULT'; }

    function pushRow(rec){
      const db = loadDB();
      const eid = getEventId();
      db[eid] ||= [];
      db[eid].push(rec);
      saveDB(db);
    }

    function getRows(){ const db=loadDB(); return db[getEventId()] || []; }
    function clearEvent(){ const db=loadDB(); delete db[getEventId()]; saveDB(db); }

    // ----------------------------
    // UI Rendering
    // ----------------------------
    function renderTable(filter=''){
      const rows = getRows();
      const tbody = $('#rows');
      tbody.innerHTML = '';
      const f = filter.toLowerCase();
      rows
        .map((r, i) => ({...r, _i: i+1}))
        .filter(r => !f || `${r.name} ${r.code}`.toLowerCase().includes(f))
        .forEach(r => {
          const tr = document.createElement('tr');
          tr.className = 'border-b border-slate-100 hover:bg-slate-50';
          tr.innerHTML = `
            <td class="px-3 py-2">${r._i}</td>
            <td class="px-3 py-2 whitespace-nowrap">${r.ts}</td>
            <td class="px-3 py-2">${escapeHtml(r.name)}</td>
            <td class="px-3 py-2 font-mono">${escapeHtml(r.code)}</td>
            <td class="px-3 py-2">${r.qty||1}</td>
            <td class="px-3 py-2">${escapeHtml(r.operator||'')}</td>
            <td class="px-3 py-2">${escapeHtml(r.station||'')}</td>`;
          tbody.appendChild(tr);
        });
      $('#statTotal').textContent = rows.length;
      $('#statLast').textContent = rows.length ? `Terakhir: ${rows[rows.length-1].ts}` : 'Terakhir: —';
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    // ----------------------------
    // CSV Export
    // ----------------------------
    function exportCSV(){
      const eid = getEventId();
      const rows = getRows();
      const headers = ['EventID','Timestamp','Name','Code','Qty','Operator','Station'];
      const csv = [headers.join(',')].concat(
        rows.map(r => [eid, r.ts, r.name, r.code, r.qty||1, r.operator||'', r.station||'']
          .map(v => `"${String(v).replaceAll('"','""')}"`).join(','))
      ).join('\n');
      const blob = new Blob(["\ufeff" + csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `guestbook_${eid}_${Date.now()}.csv`; a.click();
      URL.revokeObjectURL(url);
    }

    // ----------------------------
    // Scanner Logic (html5-qrcode)
    // ----------------------------
    let scanner = null; // Html5QrcodeScanner instance
    let scanning = false;
    let debounceText = '';

    function startScanner(){
      if (scanning) return;
      scanning = true;
      $('#qr-reader').innerHTML = '';
      scanner = new Html5QrcodeScanner('qr-reader', {
        fps: 10,
        qrbox: { width: Math.min(320, Math.floor(window.innerWidth*0.8)), height: Math.min(320, Math.floor(window.innerWidth*0.8)) },
        rememberLastUsedCamera: true,
        showTorchButtonIfSupported: true,
        showZoomSliderIfSupported: true,
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA, Html5QrcodeScanType.SCAN_TYPE_FILE],
        experimentalFeatures: { useBarCodeDetectorIfSupported: true }
      }, false);

      scanner.render(onScanSuccess, onScanFailure);
    }

    function stopScanner(){
      if (!scanning) return;
      scanning = false;
      try { scanner.clear(); } catch {}
      $('#qr-reader').innerHTML = '<div class="p-4 text-sm text-slate-500">Scanner dihentikan.</div>';
    }

    function onScanSuccess(decodedText){
      if (!decodedText) return;
      // Debounce identical frames
      if (decodedText === debounceText) return;
      debounceText = decodedText;
      setTimeout(()=>{ debounceText=''; }, 1200);

      const beep = $('#beep'); try { beep.currentTime = 0; beep.play(); } catch {}

      const parsed = parseQR(decodedText);
      // Pre-fill manual form for confirmation/edits
      $('#m_name').value = parsed.name || '';
      $('#m_code').value = parsed.code || '';
      $('#m_qty').value = parsed.qty || 1;

      // Auto-save
      saveRecord(parsed.name, parsed.code, parsed.qty);
      flashToast(`Tersimpan: ${parsed.name||'-'} (${parsed.code||'-'})`);
    }

    function onScanFailure(err){ /* ignore to keep scanner active */ }

    function parseQR(text){
      // Try JSON first
      try {
        const obj = JSON.parse(text);
        return {
          name: obj.name || obj.nama || '',
          code: obj.code || obj.kode || obj.id || '',
          qty: Number(obj.qty || obj.jumlah || 1)
        }
      } catch {}
      // Try pipe format EVT|NAMA|KODE|QTY?
      if (text.includes('|')){
        const [evt, nama, kode, qty] = text.split('|');
        // If event present and != current, still accept but keep current event id
        return { name: nama||'', code: kode||text, qty: Number(qty||1) };
      }
      // Fallback: whole text as code
      return { name: '', code: text, qty: 1 };
    }

    function saveRecord(name, code, qty){
      const rec = {
        ts: nowStr(),
        name: name?.trim() || '(Tanpa Nama)',
        code: code?.trim() || '-',
        qty: Number(qty||1),
        operator: $('#operatorName').value.trim(),
        station: $('#station').value.trim()
      };

      // Duplicate prevention by code+event (optional)
      const rows = getRows();
      const eid = getEventId();
      const dupIndex = rows.findIndex(r => r.code && r.code === rec.code);
      if (dupIndex !== -1 && rec.code !== '-'){
        flashToast(`Duplikat: kode ${rec.code} sudah tercatat (#${dupIndex+1})`, true);
      }

      pushRow(rec);
      renderTable($('#searchInput').value.trim());
    }

    // ----------------------------
    // Toast Helper
    // ----------------------------
    function flashToast(msg, isWarn=false){
      const t = document.createElement('div');
      t.className = `fixed left-1/2 -translate-x-1/2 bottom-5 z-50 px-4 py-2 rounded-xl text-white shadow-lg animate-pop ${isWarn? 'bg-amber-600':'bg-emerald-600'}`;
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=> t.remove(), 1800);
    }

    // ----------------------------
    // QR Generator
    // ----------------------------
    async function makeQR(){
      const name = $('#g_name').value.trim();
      const code = $('#g_code').value.trim();
      const event = $('#g_event').value.trim() || $('#eventId').value.trim();
      const fmt = $('#g_format').value;
      if(!code){ flashToast('Isi Kode terlebih dahulu', true); return; }
      const payload = fmt==='json' ? JSON.stringify({name, code, event}) : `${event}|${name}|${code}`;
      const canvas = $('#qrCanvas');
      canvas.classList.remove('hidden');
      await QRCode.toCanvas(canvas, payload, { width: 300, margin: 2 });
      const url = canvas.toDataURL('image/png');
      const a = $('#downloadQr');
      a.href = url; a.download = `QR_${code}.png`; a.classList.remove('hidden');
    }

    // ----------------------------
    // Event Listeners
    // ----------------------------
    window.addEventListener('DOMContentLoaded', () => {
      // Restore last event/operator
      const last = JSON.parse(localStorage.getItem('guestbook_meta')||'{}');
      if (last.eventId) $('#eventId').value = last.eventId;
      if (last.operatorName) $('#operatorName').value = last.operatorName;
      if (last.station) $('#station').value = last.station;
      renderTable('');

      $('#startScanBtn').addEventListener('click', async () => {
        persistMeta();
        try {
          await preflightCamera();
          startScanner();
        } catch (e) {
          showPermWarning(e);
        }
      });
      $('#stopScanBtn').addEventListener('click', stopScanner);

      $('#saveManual').addEventListener('click', () => {
        saveRecord($('#m_name').value, $('#m_code').value, $('#m_qty').value);
        flashToast('Input manual tersimpan');
      });
      $('#clearManual').addEventListener('click', () => { $('#m_name').value=''; $('#m_code').value=''; $('#m_qty').value=1; });

      $('#exportCsv').addEventListener('click', exportCSV);
      $('#resetData').addEventListener('click', () => {
        if (confirm('Hapus semua data untuk Event ini?')){ clearEvent(); renderTable(''); flashToast('Data acara ini dihapus', true); }
      });

      $('#searchInput').addEventListener('keydown', (e)=> { if(e.key==='Enter'){ renderTable($('#searchInput').value.trim()); }});

      $('#genQrBtn').addEventListener('click', makeQR);
      $('#downloadQr').addEventListener('click', () => {});

      // Re-render on event/operator change
      ['#eventId','#operatorName','#station'].forEach(id => document.querySelector(id).addEventListener('change', ()=>{ persistMeta(); renderTable($('#searchInput').value.trim()); }))
    });

    function persistMeta(){
      const meta = { eventId: $('#eventId').value.trim(), operatorName: $('#operatorName').value.trim(), station: $('#station').value.trim() };
      localStorage.setItem('guestbook_meta', JSON.stringify(meta));
    }

    // Preflight & Permission helpers
    async function preflightCamera(){
      const isLocalhost = ['localhost','127.0.0.1'].includes(location.hostname);
      if (!window.isSecureContext && !isLocalhost) {
        throw new Error('Akses kamera memerlukan HTTPS atau http://localhost');
      }
      if (!navigator.mediaDevices?.getUserMedia){
        throw new Error('Browser tidak mendukung getUserMedia. Coba Chrome/Edge/Safari versi terbaru.');
      }
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      stream.getTracks().forEach(t=>t.stop());
    }

    function showPermWarning(err){
      const el = document.getElementById('permWarn');
      const msg = (err && err.message) ? err.message : String(err);
      if (el){
        el.classList.remove('hidden');
        el.textContent = 'Kamera tidak bisa diakses: ' + msg + '. Coba: 1) Buka via HTTPS atau http://localhost, 2) Izinkan kamera di pengaturan browser (Site settings > Camera), 3) Pastikan kamera tidak sedang dipakai aplikasi lain.';
      } else {
        alert('Kamera tidak bisa diakses: ' + msg);
      }
    
      localStorage.setItem('guestbook_meta', JSON.stringify(meta));
    };
  </script>
</body>
</html>
