<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Buku Tamu Wedding – Simple (Auto Save on Scan)</title>

<!-- Tailwind untuk styling ringan -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Generator QR (untuk RSVP) + Barcode (opsional saat generate) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<style>
  #videoEl{ width:100%; border-radius:0.75rem; object-fit:cover; background:#0000000d; }
  canvas,img{ image-rendering: crisp-edges; }
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-4xl mx-auto p-4 md:p-6 space-y-6">

  <header class="space-y-1">
    <h1 class="text-2xl font-semibold">Buku Tamu Wedding</h1>
    <p class="text-slate-600 text-sm">RSVP → QR; Scan → <b>auto tersimpan & hadir</b>. Data lokal (IndexedDB).</p>
    <p id="secureWarn" class="hidden text-rose-600 text-sm">Harus HTTPS atau http://localhost untuk akses kamera.</p>
  </header>

  <!-- ROW: RSVP + SCANNER -->
  <section class="grid md:grid-cols-2 gap-4">
    <!-- ===== RSVP SIMPEL ===== -->
    <div class="bg-white ring-1 ring-slate-200 rounded-xl p-4 space-y-3">
      <h2 class="font-semibold">RSVP (Generate QR)</h2>
      <form id="rsvpForm" class="space-y-3">
        <div>
          <label class="text-sm text-slate-600">Nama</label>
          <input id="rsvpNama" class="mt-1 w-full rounded-lg border-slate-300 focus:ring-blue-500" placeholder="Nama tamu" required>
        </div>
        <div class="flex gap-2">
          <div class="flex-1">
            <label class="text-sm text-slate-600">Nomor</label>
            <input id="rsvpNomor" type="number" min="1" class="mt-1 w-full rounded-lg border-slate-300 focus:ring-blue-500" placeholder="otomatis jika kosong">
          </div>
          <label class="mt-6 inline-flex items-center gap-2 text-sm">
            <input id="autoNomor" type="checkbox" class="size-4" checked> Auto
          </label>
        </div>
        <details class="rounded-lg bg-slate-50 ring-1 ring-slate-200 p-3">
          <summary class="cursor-pointer text-sm">Opsi URL undangan</summary>
          <div class="pt-2">
            <input id="baseUrl" class="w-full rounded-lg border-slate-300 focus:ring-blue-500 text-sm" placeholder="https://username.github.io/repo">
            <p class="text-xs text-slate-500 mt-1">QR berisi: <code>?rsvp=TOKEN&amp;n=Nama&amp;g=Nomor</code></p>
          </div>
        </details>

        <button class="w-full py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700" type="submit">Buat QR</button>
        <div id="rsvpStatus" class="text-sm text-slate-500"></div>
      </form>

      <div class="grid grid-cols-2 gap-3 pt-2">
        <div class="ring-1 ring-slate-200 rounded-lg p-2">
          <div class="flex gap-3 mb-2 text-sm">
            <label class="inline-flex items-center gap-1"><input type="radio" name="qrtype" value="qr" checked>QR</label>
            <label class="inline-flex items-center gap-1"><input type="radio" name="qrtype" value="code128">Code128</label>
          </div>
          <div id="qrContainer" class="min-h-[220px] flex items-center justify-center"></div>
          <button id="downloadQrBtn" class="mt-2 w-full py-1.5 rounded bg-emerald-600 text-white text-sm disabled:opacity-50" disabled>Download PNG</button>
        </div>
        <div class="ring-1 ring-slate-200 rounded-lg p-2 text-xs">
          <div>Token: <span id="tokenBox" class="font-mono">—</span></div>
          <div>Nama: <span id="nameBox" class="font-mono">—</span></div>
          <div>Nomor: <span id="numBox" class="font-mono">—</span></div>
          <div class="mt-1">Payload:</div>
          <div id="payloadBox" class="font-mono break-all">—</div>
        </div>
      </div>
    </div>

    <!-- ===== SCANNER SIMPEL (AUTO SAVE) ===== -->
    <div class="bg-white ring-1 ring-slate-200 rounded-xl p-4 space-y-3">
      <h2 class="font-semibold">Scan (Auto Save + Hadir)</h2>

      <div class="grid grid-cols-2 gap-2">
        <select id="cameraSelect" class="rounded-lg border-slate-300 focus:ring-blue-500"></select>
        <input id="fileInput" type="file" accept="image/*" class="rounded-lg border-slate-300 focus:ring-blue-500" />
      </div>

      <div id="reader" class="min-h-[220px] flex items-center justify-center rounded-lg ring-1 ring-slate-200">
        <span class="text-sm text-slate-500">Klik “Mulai Scan”</span>
      </div>

      <div class="flex gap-2">
        <button id="startBtn" class="flex-1 py-2 rounded-lg bg-blue-600 text-white">Mulai Scan</button>
        <button id="stopBtn" class="py-2 px-4 rounded-lg bg-slate-700 text-white">Stop</button>
        <button id="testCamBtn" class="py-2 px-4 rounded-lg bg-amber-600 text-white">Test</button>
      </div>

      <div class="flex items-center justify-between text-sm">
        <div>Hasil: <span id="lastResult" class="font-mono text-emerald-700">—</span></div>
        <div id="scanStatus" class="text-slate-500"></div>
      </div>
    </div>
  </section>

  <!-- ===== FORM MANUAL (opsional) ===== -->
  <section class="bg-white ring-1 ring-slate-200 rounded-xl p-4 space-y-3">
    <h2 class="font-semibold">Input Manual</h2>
    <form id="guestForm" class="grid md:grid-cols-4 gap-2">
      <input id="barcodeValue" class="rounded-lg border-slate-300 focus:ring-blue-500" placeholder="Token (scan/RSVP)">
      <input id="nama" class="rounded-lg border-slate-300 focus:ring-blue-500" placeholder="Nama">
      <input id="nomorTamu" type="number" min="1" class="rounded-lg border-slate-300 focus:ring-blue-500" placeholder="Nomor">
      <div class="flex gap-2">
        <button class="flex-1 py-2 rounded-lg bg-emerald-600 text-white" type="submit">Simpan</button>
        <button id="markPresentBtn" class="flex-1 py-2 rounded-lg bg-indigo-600 text-white" type="button">Simpan + Hadir</button>
      </div>
    </form>
    <div id="statusMsg" class="text-sm text-slate-500"></div>
  </section>

  <!-- ===== TABEL ===== -->
  <section class="bg-white ring-1 ring-slate-200 rounded-xl p-4">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-semibold">Riwayat</h2>
      <div class="flex gap-2">
        <input id="searchInput" placeholder="Cari…" class="rounded-lg border-slate-300 focus:ring-blue-500">
        <button id="exportCsvBtn" class="px-3 rounded-lg bg-sky-600 text-white">Export CSV</button>
        <button id="clearAllBtn" class="px-3 rounded-lg bg-rose-600 text-white">Hapus Semua</button>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50">
          <tr><th class="px-2 py-1">Waktu</th><th class="px-2 py-1">Token</th><th class="px-2 py-1">Nomor</th><th class="px-2 py-1">Nama</th><th class="px-2 py-1">Status</th><th class="px-2 py-1">Aksi</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </section>

</div>

<script>
/* ====== Env & Util ====== */
const IS_SECURE = location.protocol === "https:" || location.hostname === "localhost" || location.hostname === "127.0.0.1";
if (!IS_SECURE) document.getElementById("secureWarn").classList.remove("hidden");
const two = n => String(n).padStart(2,"0");
const isoToLocal = iso => {const d=new Date(iso);return `${two(d.getDate())}/${two(d.getMonth()+1)}/${d.getFullYear()} ${two(d.getHours())}:${two(d.getMinutes())}`;}
const slugify = s => s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,32);
const rndToken = (len=8)=>Array.from(crypto.getRandomValues(new Uint32Array(len)),n=>(n%36).toString(36)).join('');
function beepOK(){try{const c=new (window.AudioContext||window.webkitAudioContext)();const o=c.createOscillator(),g=c.createGain();o.type="square";o.frequency.value=880;o.connect(g);g.connect(c.destination);g.gain.setValueAtTime(0.05,c.currentTime);o.start();setTimeout(()=>{o.stop();c.close();},120);}catch{}}

/* ====== Payload ====== */
let INVITE_BASE_URL="";
function buildToken(name, nomor){ return `${slugify(name||"tamu")}-${nomor||"x"}-${rndToken(4)}`; }
function buildPayload(token,name,nomor){
  if(INVITE_BASE_URL){const u=new URL(INVITE_BASE_URL);u.searchParams.set("rsvp",token);if(name)u.searchParams.set("n",name);if(nomor!==""&&nomor!=null)u.searchParams.set("g",nomor);return u.toString();}
  return `RSVP2|${token}|${encodeURIComponent(name||"")}|${encodeURIComponent(String(nomor||""))}`;
}
function parseScanned(text){
  try{const u=new URL(text);const tok=u.searchParams.get("rsvp");if(tok)return{token:tok,name:u.searchParams.get("n")||"",nomor:u.searchParams.get("g")||""};}catch{}
  const m2=/^RSVP2\|([^|]+)\|([^|]*)\|([^|]*)$/i.exec(text||"");if(m2)return{token:m2[1],name:decodeURIComponent(m2[2]||""),nomor:decodeURIComponent(m2[3]||"")};
  const m=/^RSVP\|([^|]+)\|?(.*)$/i.exec(text||"");if(m)return{token:m[1],name:decodeURIComponent(m[2]||""),nomor:""};
  return {token:text,name:"",nomor:""};
}

/* ====== IndexedDB ====== */
const DB="bukuTamu_simple", STORE="tamu"; let db=null;
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB,1);r.onupgradeneeded=()=>{const s=r.result.createObjectStore(STORE,{keyPath:"id",autoIncrement:true});s.createIndex("barcode","barcode");s.createIndex("waktu","waktu");s.createIndex("nomor","nomor");};r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
const tx=(m)=>db.transaction(STORE,m).objectStore(STORE);
const addEntry=(e)=>new Promise((res,rej)=>{const q=tx("readwrite").add(e);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});
const putEntry=(e)=>new Promise((res,rej)=>{const q=tx("readwrite").put(e);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});
const getAll =()=>new Promise((res,rej)=>{const q=tx("readonly").getAll();q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});
const getById=(id)=>new Promise((res,rej)=>{const q=tx("readonly").get(id);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});
const findByBarcode=(b)=>new Promise((res,rej)=>{const q=tx("readonly").index("barcode").getAll(b);q.onsuccess=()=>res(q.result||[]);q.onerror=()=>rej(q.error);});
const delById=(id)=>new Promise((res,rej)=>{const q=tx("readwrite").delete(id);q.onsuccess=()=>res(true);q.onerror=()=>rej(q.error);});
const clearAll=()=>new Promise((res,rej)=>{const q=tx("readwrite").clear();q.onsuccess=()=>res(true);q.onerror=()=>rej(q.error);});
async function getNextNomor(){ const rows=await getAll(); const ns=rows.map(r=>Number(r.nomor)).filter(Number.isFinite); return ns.length?Math.max(...ns)+1:1; }

/* ====== Tabel ====== */
function renderTable(rows){
  const q=(document.getElementById("searchInput").value||"").toLowerCase();
  const tb=document.getElementById("tableBody"); tb.innerHTML="";
  rows.filter(r=>!q || (r.nama||"").toLowerCase().includes(q) || (r.barcode||"").toLowerCase().includes(q) || String(r.nomor||"").includes(q))
      .sort((a,b)=>new Date(b.waktu)-new Date(a.waktu))
      .forEach(r=>{
        const tr=document.createElement("tr"); tr.className="border-t";
        tr.innerHTML=`<td class="px-2 py-1 whitespace-nowrap">${isoToLocal(r.waktu)}</td>
                      <td class="px-2 py-1 font-mono text-xs break-all">${r.barcode}</td>
                      <td class="px-2 py-1">${r.nomor??"—"}</td>
                      <td class="px-2 py-1">${r.nama||"—"}</td>
                      <td class="px-2 py-1">${r.hadir?'<span class="text-emerald-700">Hadir</span>':'Draft'}</td>
                      <td class="px-2 py-1">
                        <button data-id="${r.id}" class="delBtn text-rose-600 underline text-xs">Hapus</button>
                        ${r.hadir?'':`<button data-id="${r.id}" class="markBtn text-indigo-600 underline text-xs ml-2">Tandai Hadir</button>`}
                      </td>`;
        tb.appendChild(tr);
      });
  tb.querySelectorAll(".delBtn").forEach(b=>b.addEventListener("click",async e=>{await delById(Number(e.target.dataset.id));refreshTable();}));
  tb.querySelectorAll(".markBtn").forEach(b=>b.addEventListener("click",async e=>{
    const row=await getById(Number(e.target.dataset.id)); if(!row) return;
    row.hadir=true; row.waktuHadir=new Date().toISOString(); await putEntry(row); refreshTable();
  }));
}
async function refreshTable(){ renderTable(await getAll()); }

/* ====== Export CSV ====== */
function toCSV(rows){const H=["id","waktu","barcode","nomor","nama","hadir","waktuHadir"];const E=v=>v==null?"":`"${String(v).replace(/"/g,'""')}"`;return[H.map(E).join(",")].concat(rows.map(r=>H.map(h=>E(r[h])).join(","))).join("\r\n");}
function download(name,text){const blob=new Blob([text],{type:"text/csv;charset=utf-8;"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}

/* ====== Generate QR/Barcode ====== */
let lastToken="", lastPayload="";
function renderQRorBarcode(payload){
  const type=document.querySelector('input[name="qrtype"]:checked')?.value||"qr";
  const wrap=document.getElementById("qrContainer"); wrap.innerHTML="";
  if(type==="qr"){ new QRCode(wrap,{text:payload,width:220,height:220,correctLevel:QRCode.CorrectLevel.M}); }
  else{ const svg=document.createElementNS("http://www.w3.org/2000/svg","svg"); wrap.appendChild(svg); JsBarcode(svg,payload,{format:"code128",width:2,height:100,margin:8,displayValue:false}); }
  document.getElementById("downloadQrBtn").disabled=false;
}
function downloadCurrentPNG(){
  const cont=document.getElementById("qrContainer"); const img=cont.querySelector("img");
  if(img){ trigger(img.src); return; }
  const svg=cont.querySelector("svg"); if(svg){ const xml=new XMLSerializer().serializeToString(svg); trigger('data:image/svg+xml;charset=utf-8,'+encodeURIComponent(xml)); return; }
  function trigger(url){const a=document.createElement("a");a.href=url;a.download=`RSVP-${lastToken}.png`;document.body.appendChild(a);a.click();a.remove();}
}

/* ====== Native Scanner (BarcodeDetector) ====== */
let stream=null, detector=null, rafId=null, scanning=false, lastText="", lastAt=0, currentDeviceId=null;
function setScanStatus(msg,isErr=false){const el=document.getElementById("scanStatus");el.textContent=msg;el.className="text-sm "+(isErr?"text-rose-600":"text-slate-500");}

async function listCameras(){
  const sel=document.getElementById("cameraSelect"); sel.innerHTML="";
  try{
    try{const t=await navigator.mediaDevices.getUserMedia({video:true,audio:false});t.getTracks().forEach(x=>x.stop());}catch{}
    const devs=await navigator.mediaDevices.enumerateDevices();
    const cams=devs.filter(d=>d.kind==="videoinput");
    if(!cams.length){ sel.innerHTML=`<option>Tidak ada kamera</option>`; return; }
    const back=cams.find(c=>/back|rear|environment/i.test(c.label||""))||cams[0];
    cams.forEach((d,i)=>{const o=document.createElement("option");o.value=d.deviceId;o.textContent=d.label||`Kamera ${i+1}`;sel.appendChild(o);});
    currentDeviceId=back.deviceId; sel.value=currentDeviceId;
    sel.onchange=e=>{ currentDeviceId=e.target.value; if(scanning){ stopScan().then(startScan); } };
  }catch(e){ sel.innerHTML=`<option>Gagal membaca kamera</option>`; }
}

async function startScan(){
  if(!IS_SECURE){ setScanStatus("Harus HTTPS/localhost.",true); return; }
  if(!navigator.mediaDevices?.getUserMedia){ setScanStatus("getUserMedia tidak tersedia.",true); return; }
  if(!("BarcodeDetector" in window)){ setScanStatus("Browser belum mendukung BarcodeDetector (coba Chrome Android terbaru).",true); return; }

  // pilih format yang didukung
  let fmts=['qr_code','code_128','code_39','ean_13','ean_8','upc_a','upc_e','itf','codabar'];
  try{const sup=await BarcodeDetector.getSupportedFormats(); fmts=fmts.filter(f=>sup.includes(f)); if(!fmts.length) fmts=['qr_code'];}catch{}
  detector=new BarcodeDetector({formats:fmts});

  try{
    const cons=currentDeviceId?{video:{deviceId:{exact:currentDeviceId}},audio:false}:{video:{facingMode:{ideal:"environment"}},audio:false};
    stream=await navigator.mediaDevices.getUserMedia(cons);
    const reader=document.getElementById("reader"); reader.innerHTML="";
    const v=document.createElement("video"); v.id="videoEl"; v.setAttribute("playsinline",""); v.muted=true; v.autoplay=true; v.srcObject=stream; await v.play(); reader.appendChild(v);
    scanning=true; setScanStatus(`Kamera aktif (${fmts.join(", ")}).`);

    const tick=async()=>{
      if(!scanning) return;
      try{
        const codes=await detector.detect(v);
        if(codes && codes.length){
          const text=codes[0].rawValue; const now=Date.now();
          if(text!==lastText || now-lastAt>800){ lastText=text; lastAt=now; onScan(text, /*auto*/true); }
        }
      }catch{}
      rafId=requestAnimationFrame(tick);
    }; tick();
  }catch(e){ setScanStatus(mapMediaError(e),true); }
}

async function stopScan(){
  scanning=false; if(rafId) cancelAnimationFrame(rafId);
  if(stream){ try{stream.getTracks().forEach(t=>t.stop());}catch{} stream=null; }
  document.getElementById("reader").innerHTML='<span class="text-sm text-slate-500">Klik “Mulai Scan”</span>';
  setScanStatus("Kamera berhenti.");
}
function mapMediaError(e){const n=e?.name||""; if(n==="NotAllowedError")return"Akses kamera ditolak."; if(n==="NotFoundError")return"Kamera tidak ditemukan."; if(n==="NotReadableError")return"Kamera dipakai app lain."; if(n==="OverconstrainedError")return"Constraint tidak cocok."; if(n==="SecurityError")return"Origin tidak aman."; return `Gagal akses kamera: ${n||e}`;}
async function testCameraBasic(){ if(!IS_SECURE){alert("Bukan HTTPS/localhost");return;} try{const s=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); s.getTracks().forEach(t=>t.stop()); alert("Kamera OK & izin diberikan.");}catch(e){alert("Gagal akses kamera: "+(e.name||e));} }

/* ====== AUTO SAVE on SCAN ====== */
async function autoSaveFromScan(parsed, raw){
  const barcode = parsed.token || raw;
  const nama = parsed.name || "";
  const nomor = parsed.nomor || "";

  const exists = await findByBarcode(barcode);
  if(exists.length){
    const row = exists[0];
    // update info jika kosong
    if(nama && !row.nama) row.nama = nama;
    if(nomor && !row.nomor) row.nomor = nomor;
    row.hadir = true;
    row.waktuHadir = new Date().toISOString();
    await putEntry(row);
  }else{
    await addEntry({
      waktu: new Date().toISOString(),
      barcode, nama, nomor,
      hadir: true,
      waktuHadir: new Date().toISOString()
    });
  }
  await refreshTable();
}

/* ====== Event: hasil scan ====== */
function onScan(raw, auto=false){
  beepOK();
  document.getElementById("lastResult").textContent = raw;
  const p = parseScanned(raw);

  // isi form manual sekadar referensi
  document.getElementById("barcodeValue").value = p.token || raw;
  if (p.name)  document.getElementById("nama").value = p.name;
  if (p.nomor) document.getElementById("nomorTamu").value = p.nomor;

  if (auto) {
    setScanStatus("Terbaca. Disimpan otomatis + Hadir.", false);
    autoSaveFromScan(p, raw);
  }
}

/* ====== Form manual ====== */
function setStatus(msg,isErr=false){const el=document.getElementById("statusMsg");el.textContent=msg;el.className="text-sm "+(isErr?"text-rose-600":"text-slate-500");}
async function handleSave(markPresent=false){
  const barcode=(document.getElementById("barcodeValue").value||"").trim();
  const nama=(document.getElementById("nama").value||"").trim();
  const nomor=(document.getElementById("nomorTamu").value||"").trim();
  if(!barcode){ setStatus("Token wajib diisi.",true); return; }
  const exists=await findByBarcode(barcode);
  if(exists.length){
    const row=exists[0]; row.nama=nama||row.nama; row.nomor=nomor||row.nomor;
    if(markPresent){ row.hadir=true; row.waktuHadir=new Date().toISOString(); }
    await putEntry(row);
  }else{
    await addEntry({ waktu:new Date().toISOString(), barcode, nama, nomor, hadir:!!markPresent, waktuHadir: markPresent? new Date().toISOString(): null });
  }
  setStatus(markPresent?"Tersimpan + Hadir.":"Tersimpan.");
  refreshTable();
}

/* ====== RSVP ====== */
document.getElementById("rsvpForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  INVITE_BASE_URL=(document.getElementById("baseUrl").value||"").trim();
  const nama=document.getElementById("rsvpNama").value.trim();
  let nomor=document.getElementById("rsvpNomor").value.trim();
  const auto=document.getElementById("autoNomor").checked;
  if(!nama){ setRSVPStatus("Nama wajib diisi.",true); return; }
  if(auto || !nomor){ nomor=String(await getNextNomor()); document.getElementById("rsvpNomor").value=nomor; }
  lastToken=buildToken(nama,nomor);
  lastPayload=buildPayload(lastToken,nama,nomor);
  renderQRorBarcode(lastPayload);
  document.getElementById("tokenBox").textContent=lastToken;
  document.getElementById("nameBox").textContent=nama;
  document.getElementById("numBox").textContent=nomor;
  document.getElementById("payloadBox").textContent=lastPayload;
  // simpan draft RSVP (tidak hadir)
  const exists=await findByBarcode(lastToken);
  if(!exists.length){ await addEntry({ waktu:new Date().toISOString(), barcode:lastToken, nama, nomor, hadir:false, waktuHadir:null }); await refreshTable(); }
  setRSVPStatus("QR dibuat. Silakan download/ bagikan.");
});
function setRSVPStatus(msg,isErr=false){const el=document.getElementById("rsvpStatus"); el.textContent=msg; el.className="text-sm "+(isErr?"text-rose-600":"text-slate-500");}
document.getElementById("downloadQrBtn").addEventListener("click",()=>{ // download QR/Barcode
  const cont=document.getElementById("qrContainer"); const img=cont.querySelector("img");
  if(img){ const a=document.createElement("a"); a.href=img.src; a.download=`RSVP-${lastToken}.png`; document.body.appendChild(a); a.click(); a.remove(); return; }
  const svg=cont.querySelector("svg"); if(svg){ const xml=new XMLSerializer().serializeToString(svg); const url='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(xml); const a=document.createElement("a"); a.href=url; a.download=`RSVP-${lastToken}.png`; document.body.appendChild(a); a.click(); a.remove(); }
});
document.querySelectorAll('input[name="qrtype"]').forEach(r=>r.addEventListener("change",()=>{ if(lastPayload){ renderQRorBarcode(lastPayload); }}));

/* ====== Bindings ====== */
document.getElementById("startBtn").addEventListener("click", startScan);
document.getElementById("stopBtn").addEventListener("click", stopScan);
document.getElementById("testCamBtn").addEventListener("click", testCameraBasic);
document.getElementById("fileInput").addEventListener("change", async (e)=>{ const f=e.target.files?.[0]; if(!f) return; if(!("BarcodeDetector" in window)){ setScanStatus("Perangkat tidak dukung scan file.",true); return; } const bmp=await createImageBitmap(f); const det=new BarcodeDetector({formats:['qr_code']}); const res=await det.detect(bmp); if(res&&res.length){ onScan(res[0].rawValue,true); } else { setScanStatus("Tidak terbaca dari gambar.",true);} e.target.value=""; });
document.getElementById("guestForm").addEventListener("submit", async (e)=>{ e.preventDefault(); await handleSave(false); });
document.getElementById("markPresentBtn").addEventListener("click", async ()=>{ await handleSave(true); });
document.getElementById("searchInput").addEventListener("input", refreshTable);
document.getElementById("exportCsvBtn").addEventListener("click", async ()=>{ const rows=await getAll(); download(`buku-tamu-${new Date().toISOString().slice(0,10)}.csv`, toCSV(rows)); });
document.getElementById("clearAllBtn").addEventListener("click", async ()=>{ if(!confirm("Hapus semua data lokal?")) return; await clearAll(); refreshTable(); });

/* ====== INIT ====== */
(async function(){ db=await openDB(); await listCameras(); await refreshTable(); })();
</script>
</body>
</html>
