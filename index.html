<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RSVP + Buku Tamu (Native Scanner, No CDN)</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- QR Generator (hanya untuk membuat QR tamu) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- Barcode Generator (untuk opsi Code128 saat generate) -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<style>
  canvas, img { image-rendering: crisp-edges; }
  .badge { padding:2px 8px; border-radius:999px; font-size:12px }
  #videoEl { width: 100%; border-radius: 0.75rem; object-fit: cover; }
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-6xl mx-auto p-4 md:p-8">
  <header class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl md:text-3xl font-semibold">RSVP + Buku Tamu (Native Scanner)</h1>
      <p class="text-sm text-slate-500">RSVP → generate QR/Barcode (Nama + Nomor + Token), simpan lokal (IndexedDB), scan pakai <b>BarcodeDetector</b> (tanpa CDN).</p>
      <div id="secureWarn" class="mt-2 hidden">
        <span class="badge bg-rose-100 text-rose-700 ring-1 ring-rose-200">PENTING</span>
        <span class="text-sm text-rose-700">Harus HTTPS atau http://localhost agar kamera bisa dipakai.</span>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="exportCsvBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Export CSV</button>
      <button id="clearAllBtn" class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700">Hapus Semua</button>
    </div>
  </header>

  <!-- ========== RSVP (Tamu) ========== -->
  <section class="grid md:grid-cols-2 gap-6">
    <div class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200 p-4">
      <h2 class="text-lg font-semibold mb-3">Form RSVP (Tamu)</h2>
      <form id="rsvpForm" class="grid gap-3">
        <label class="block">
          <span class="text-sm text-slate-600">Nama Tamu</span>
          <input id="rsvpNama" type="text" required placeholder="Contoh: Bapak/Ibu Andi Wijaya"
                 class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"/>
        </label>
        <div class="grid md:grid-cols-3 gap-3">
          <label class="block md:col-span-2">
            <span class="text-sm text-slate-600">Nomor Tamu</span>
            <input id="rsvpNomor" type="number" min="1" placeholder="Contoh: 105"
                   class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"/>
          </label>
          <label class="inline-flex items-center gap-2 mt-6">
            <input id="autoNomor" type="checkbox" class="size-4" checked />
            <span class="text-sm text-slate-700">Auto nomor</span>
          </label>
        </div>
        <div class="grid md:grid-cols-2 gap-3">
          <label class="block">
            <span class="text-sm text-slate-600">No. HP (opsional)</span>
            <input id="rsvpTelp" type="tel" placeholder="08xxxxxxxxxx"
                   class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"/>
          </label>
          <label class="block">
            <span class="text-sm text-slate-600">Keterangan (opsional)</span>
            <input id="rsvpCatatan" type="text" placeholder="Instansi/Relasi"
                   class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"/>
          </label>
        </div>
        <details class="rounded-lg bg-slate-50 ring-1 ring-slate-200 p-3">
          <summary class="text-sm cursor-pointer select-none">Pengaturan URL Undangan (opsional)</summary>
          <div class="pt-2 grid gap-2">
            <label class="block">
              <span class="text-sm text-slate-600">INVITE_BASE_URL</span>
              <input id="baseUrl" type="url" placeholder="https://<username>.github.io/<repo>"
                     class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"/>
            </label>
            <p class="text-xs text-slate-500">Jika diisi, QR = <code>?rsvp=TOKEN&amp;n=Nama&amp;g=Nomor</code> pada URL ini.</p>
          </div>
        </details>
        <div class="flex items-center gap-3 mt-1">
          <button class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700" type="submit">Kirim RSVP & Buat QR</button>
          <span id="rsvpStatus" class="text-sm text-slate-500"></span>
        </div>
      </form>

      <!-- Preview -->
      <div id="previewWrap" class="mt-4 grid md:grid-cols-2 gap-3 items-start">
        <div class="rounded-xl ring-1 ring-slate-200 p-3">
          <div class="text-sm text-slate-600 mb-1">QR/Barcode Preview</div>
          <div class="flex items-center gap-3 mb-2">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="qrtype" value="qr" checked class="size-4"/>
              <span class="text-sm">QR Code</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="qrtype" value="code128" class="size-4"/>
              <span class="text-sm">Barcode Code128</span>
            </label>
          </div>
          <div id="qrContainer" class="flex items-center justify-center min-h-[260px]"></div>
          <div class="flex items-center gap-3 mt-2">
            <button id="downloadQrBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm hover:bg-emerald-700" disabled>Download PNG</button>
          </div>
        </div>
        <div class="rounded-xl ring-1 ring-slate-200 p-3">
          <div class="text-sm text-slate-600 mb-1">Payload</div>
          <div id="payloadBox" class="text-xs font-mono break-all">—</div>
          <div class="text-xs text-slate-500 mt-2">Token: <span id="tokenBox" class="font-mono">—</span></div>
          <div class="text-xs text-slate-500">Nama: <span id="nameBox" class="font-mono">—</span></div>
          <div class="text-xs text-slate-500">Nomor: <span id="numBox" class="font-mono">—</span></div>
        </div>
      </div>
    </div>

    <!-- ========== Scanner (Panitia) – Native ========== -->
    <div class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200 p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Scanner Kamera (Panitia)</h2>
        <span class="text-xs text-slate-500">HTTPS/localhost + Allow camera</span>
      </div>

      <div class="grid md:grid-cols-2 gap-3 mb-3">
        <label class="block">
          <span class="text-sm text-slate-600">Pilih Kamera</span>
          <select id="cameraSelect" class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"></select>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Scan dari Gambar</span>
          <input id="fileInput" type="file" accept="image/*" class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500" />
        </label>
      </div>

      <div id="reader" class="w-full rounded-xl ring-1 ring-slate-200 bg-black/5 min-h-[260px] flex items-center justify-center text-slate-500">
        <span class="text-sm">Klik “Mulai Scan” untuk menyalakan kamera</span>
      </div>

      <div class="flex items-center gap-3 mt-4">
        <button id="startBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Mulai Scan</button>
        <button id="stopBtn" class="px-4 py-2 rounded-xl bg-slate-700 text-white hover:bg-slate-800">Stop</button>
        <button id="testCamBtn" class="px-4 py-2 rounded-xl bg-amber-600 text-white hover:bg-amber-700">Test Kamera</button>
        <span id="scanStatus" class="ml-auto text-sm text-slate-500"></span>
      </div>

      <div class="mt-4 p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200">
        <div class="text-sm text-slate-600">Hasil terakhir:</div>
        <div id="lastResult" class="mt-1 font-mono text-sm break-all text-emerald-700">—</div>
      </div>
    </div>
  </section>

  <!-- ========== Form Panitia ========== -->
  <section class="mt-8 rounded-2xl bg-white shadow-sm ring-1 ring-slate-200 p-4">
    <h2 class="text-lg font-semibold mb-3">Detail Tamu (Panitia)</h2>
    <form id="guestForm" class="grid grid-cols-1 gap-3">
      <div class="grid md:grid-cols-3 gap-3">
        <label class="block">
          <span class="text-sm text-slate-600">Token</span>
          <input id="barcodeValue" type="text" required placeholder="Terisi dari scan/RSVP"
                 class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"/>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Nomor Tamu</span>
          <input id="nomorTamu" type="number" min="1" placeholder="Nomor"
                 class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"/>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Nama</span>
          <input id="nama" type="text" placeholder="Nama Tamu"
                 class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"/>
        </label>
      </div>

      <div class="grid md:grid-cols-2 gap-3">
        <label class="block">
          <span class="text-sm text-slate-600">No. HP (opsional)</span>
          <input id="telp" type="tel" placeholder="08xxxxxxxxxx"
                 class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"/>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Keterangan (opsional)</span>
          <input id="catatan" type="text" placeholder="Instansi/Relasi"
                 class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"/>
        </label>
      </div>

      <div class="flex items-center gap-3 mt-1">
        <button class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700" type="submit">Simpan/Perbarui</button>
        <button id="markPresentBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700" type="button">Simpan + Hadir</button>
        <span id="statusMsg" class="text-sm text-slate-500"></span>
      </div>
    </form>
  </section>

  <!-- ========== Tabel Riwayat ========== -->
  <section class="mt-8 rounded-2xl bg-white shadow-sm ring-1 ring-slate-200 p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Riwayat Buku Tamu</h2>
      <input id="searchInput" type="text" placeholder="Cari nama/nomor/token..." class="w-56 rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500" />
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50">
          <tr class="text-left">
            <th class="px-3 py-2">Waktu</th>
            <th class="px-3 py-2">Token</th>
            <th class="px-3 py-2">Nomor</th>
            <th class="px-3 py-2">Nama</th>
            <th class="px-3 py-2">HP</th>
            <th class="px-3 py-2">Keterangan</th>
            <th class="px-3 py-2">Status</th>
            <th class="px-3 py-2">Aksi</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </section>

  <footer class="text-center text-xs text-slate-500 mt-8">
    <p>HTTPS/localhost wajib untuk kamera. Data disimpan lokal (IndexedDB). Isi <code>INVITE_BASE_URL</code> (opsional) agar payload QR berupa URL undangan.</p>
  </footer>
</div>

<script>
/* ================== ENV & UTIL ================== */
const IS_SECURE = location.protocol === "https:" || location.hostname === "localhost" || location.hostname === "127.0.0.1";
if (!IS_SECURE) document.getElementById("secureWarn").classList.remove("hidden");
const two=n=>String(n).padStart(2,"0");
const isoToLocal=iso=>{const d=new Date(iso);return `${two(d.getDate())}/${two(d.getMonth()+1)}/${d.getFullYear()} ${two(d.getHours())}:${two(d.getMinutes())}`;}
const slugify=s=>s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,32);
const rndToken=(len=8)=>Array.from(crypto.getRandomValues(new Uint32Array(len)),n=>(n%36).toString(36)).join('');
let INVITE_BASE_URL="";

function beepOK(){try{const ctx=new (window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator(),g=ctx.createGain();o.type="square";o.frequency.value=880;o.connect(g);g.connect(ctx.destination);g.gain.setValueAtTime(0.05,ctx.currentTime);o.start();setTimeout(()=>{o.stop();ctx.close();},120);}catch{}}

/* ================== PAYLOAD ================== */
function buildToken(name, nomor){ return `${slugify(name||"tamu")}-${nomor||"x"}-${rndToken(4)}`; }
function buildPayload(token, name, nomor){
  if (INVITE_BASE_URL) {
    const u = new URL(INVITE_BASE_URL);
    u.searchParams.set("rsvp", token);
    if (name)  u.searchParams.set("n", name);
    if (nomor !== "" && nomor != null) u.searchParams.set("g", nomor);
    return u.toString();
  }
  return `RSVP2|${token}|${encodeURIComponent(name||"")}|${encodeURIComponent(String(nomor||""))}`;
}
function parseScanned(text){
  try { const u=new URL(text); const tok=u.searchParams.get("rsvp");
    if (tok) return { token: tok, name: u.searchParams.get("n")||"", nomor: u.searchParams.get("g")||"" };
  } catch {}
  const m2=/^RSVP2\|([^|]+)\|([^|]*)\|([^|]*)$/i.exec(text||"");
  if(m2) return { token:m2[1], name: decodeURIComponent(m2[2]||""), nomor: decodeURIComponent(m2[3]||"") };
  const m=/^RSVP\|([^|]+)\|?(.*)$/i.exec(text||"");
  if(m) return { token:m[1], name: decodeURIComponent(m[2]||""), nomor: "" };
  return { token:text, name:"", nomor:"" };
}

/* ================== IndexedDB ================== */
const DB_NAME="bukuTamuDB_native", STORE="tamu"; let db=null;
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,1);r.onupgradeneeded=()=>{const _db=r.result;const s=_db.createObjectStore(STORE,{keyPath:"id",autoIncrement:true});s.createIndex("barcode","barcode");s.createIndex("waktu","waktu");s.createIndex("nomor","nomor");};r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
const tx=(mode)=>db.transaction(STORE,mode).objectStore(STORE);
const addEntry=(e)=>new Promise((res,rej)=>{const q=tx("readwrite").add(e);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});
const putEntry=(e)=>new Promise((res,rej)=>{const q=tx("readwrite").put(e);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});
const getAll=()=>new Promise((res,rej)=>{const q=tx("readonly").getAll();q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});
const getById=(id)=>new Promise((res,rej)=>{const q=tx("readonly").get(id);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});
const findByBarcode=(b)=>new Promise((res,rej)=>{const q=tx("readonly").index("barcode").getAll(b);q.onsuccess=()=>res(q.result||[]);q.onerror=()=>rej(q.error);});
const delById=(id)=>new Promise((res,rej)=>{const q=tx("readwrite").delete(id);q.onsuccess=()=>res(true);q.onerror=()=>rej(q.error);});
const clearAll=()=>new Promise((res,rej)=>{const q=tx("readwrite").clear();q.onsuccess=()=>res(true);q.onerror=()=>rej(q.error);});
async function getNextNomor(){ const rows=await getAll(); const ns=rows.map(r=>Number(r.nomor)).filter(Number.isFinite); return ns.length?Math.max(...ns)+1:1; }

/* ================== Tabel ================== */
function renderTable(rows){
  const q=(document.getElementById("searchInput").value||"").toLowerCase();
  const tb=document.getElementById("tableBody"); tb.innerHTML="";
  rows.filter(r=>!q || (r.nama||"").toLowerCase().includes(q) || (r.barcode||"").toLowerCase().includes(q) || String(r.nomor||"").includes(q))
      .sort((a,b)=>new Date(b.waktu)-new Date(a.waktu))
      .forEach(r=>{
        const tr=document.createElement("tr"); tr.className="border-t border-slate-100 hover:bg-slate-50";
        tr.innerHTML=`
          <td class="px-3 py-2 whitespace-nowrap">${isoToLocal(r.waktu)}</td>
          <td class="px-3 py-2 break-all font-mono text-xs">${r.barcode||"—"}</td>
          <td class="px-3 py-2 whitespace-nowrap">${r.nomor??"—"}</td>
          <td class="px-3 py-2">${r.nama||"—"}</td>
          <td class="px-3 py-2 whitespace-nowrap">${r.telp||"—"}</td>
          <td class="px-3 py-2">${r.catatan||"—"}</td>
          <td class="px-3 py-2">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs ${r.hadir?"bg-emerald-100 text-emerald-700":"bg-slate-100 text-slate-600"}">${r.hadir?"Hadir":"Draft"}</span>
          </td>
          <td class="px-3 py-2">
            <button data-id="${r.id}" class="delBtn text-rose-600 hover:underline">Hapus</button>
            ${r.hadir?"":`<button data-id="${r.id}" class="markBtn ml-2 text-indigo-600 hover:underline">Tandai Hadir</button>`}
          </td>`;
        tb.appendChild(tr);
      });
  tb.querySelectorAll(".delBtn").forEach(b=>b.addEventListener("click",async e=>{await delById(Number(e.target.dataset.id)); refreshTable();}));
  tb.querySelectorAll(".markBtn").forEach(b=>b.addEventListener("click",async e=>{
    const id=Number(e.target.dataset.id); const row=await getById(id); if(!row) return;
    row.hadir=true; row.waktuHadir=new Date().toISOString(); await putEntry(row); refreshTable();
  }));
}
async function refreshTable(){ renderTable(await getAll()); }

/* ================== Export CSV ================== */
function toCSV(rows){ const headers=["id","waktu","barcode","nomor","nama","telp","catatan","hadir","waktuHadir","remoteStatus"]; const esc=v=>v==null?"":`"${String(v).replace(/"/g,'""')}"`; return [headers.map(esc).join(",")].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(","))).join("\r\n"); }
function download(filename,text){ const blob=new Blob([text],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

/* ================== Generate QR/Barcode ================== */
let lastToken="", lastPayload="";
function renderQRorBarcode(payload){
  const type=document.querySelector('input[name="qrtype"]:checked')?.value||"qr";
  const wrap=document.getElementById("qrContainer"); wrap.innerHTML="";
  if(type==="qr"){ new QRCode(wrap,{text:payload,width:260,height:260,correctLevel:QRCode.CorrectLevel.M}); }
  else{ const svg=document.createElementNS("http://www.w3.org/2000/svg","svg"); wrap.appendChild(svg); JsBarcode(svg,payload,{format:"code128",width:2,height:120,margin:10,displayValue:false}); }
  document.getElementById("downloadQrBtn").disabled=false;
}
function downloadCurrentPNG(){
  const cont=document.getElementById("qrContainer"); const img=cont.querySelector("img");
  if(img){ triggerDownload(img.src,`RSVP-${lastToken}.png`); return; }
  const svg=cont.querySelector("svg"); if(svg){ const xml=new XMLSerializer().serializeToString(svg); const dataUrl='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(xml); triggerDownload(dataUrl,`RSVP-${lastToken}.png`); return; }
  alert("Tidak ada gambar untuk diunduh.");
}
function triggerDownload(url,filename){ const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }

/* ================== Native Scanner (BarcodeDetector) ================== */
let stream=null, detector=null, rafId=null, scanning=false, lastText="", lastAt=0, currentDeviceId=null;

function setScanStatus(msg,isErr=false){ const el=document.getElementById("scanStatus"); el.textContent=msg; el.className="text-sm "+(isErr?"text-rose-600":"text-slate-500"); }

async function listCameras(){
  const sel=document.getElementById("cameraSelect"); sel.innerHTML="";
  try{
    // Minta izin dulu agar label kamera terbaca
    try{
      const tmp=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
      tmp.getTracks().forEach(t=>t.stop());
    }catch{}
    const devs=await navigator.mediaDevices.enumerateDevices();
    const cams=devs.filter(d=>d.kind==="videoinput");
    if(cams.length===0){ sel.innerHTML=`<option value="">Tidak ada kamera</option>`; return; }
    const back=cams.find(c=>/back|rear|environment/i.test(c.label||""))||cams[0];
    cams.forEach((d,i)=>{const opt=document.createElement("option"); opt.value=d.deviceId; opt.textContent=d.label||`Kamera ${i+1}`; sel.appendChild(opt);});
    currentDeviceId=back.deviceId; sel.value=currentDeviceId;
    sel.onchange=e=>{ currentDeviceId=e.target.value; if(scanning){ stopScan().then(startScan); } };
  }catch(e){ sel.innerHTML=`<option value="">Gagal membaca kamera: ${e?.name||e}</option>`; }
}

async function startScan(){
  if(!IS_SECURE){ setScanStatus("Harus HTTPS/localhost.",true); return; }
  if(!navigator.mediaDevices?.getUserMedia){ setScanStatus("getUserMedia tidak tersedia di browser ini.",true); return; }
  if(!("BarcodeDetector" in window)){ setScanStatus("Browser belum mendukung BarcodeDetector. Coba Chrome/Edge Android terbaru.",true); return; }

  // pilih format yang didukung device
  let formatsWanted=['qr_code','code_128','code_39','ean_13','ean_8','upc_a','upc_e','itf','codabar'];
  try{
    const supported=await BarcodeDetector.getSupportedFormats();
    formatsWanted=formatsWanted.filter(f=>supported.includes(f));
    if(formatsWanted.length===0) formatsWanted=['qr_code']; // minimal QR
  }catch{ /* ignore */ }

  detector=new BarcodeDetector({formats:formatsWanted});

  try{
    const constraints=currentDeviceId?{video:{deviceId:{exact:currentDeviceId}},audio:false}:{video:{facingMode:{ideal:"environment"}},audio:false};
    stream=await navigator.mediaDevices.getUserMedia(constraints);

    // buat elemen video di #reader
    const reader=document.getElementById("reader");
    reader.innerHTML="";
    const video=document.createElement("video");
    video.id="videoEl"; video.setAttribute("playsinline",""); video.muted=true; video.autoplay=true;
    video.srcObject=stream; await video.play();
    reader.appendChild(video);

    scanning=true; setScanStatus(`Kamera aktif (${formatsWanted.join(", ")}).`);

    const tick=async()=>{
      if(!scanning) return;
      try{
        const codes=await detector.detect(video);
        if(codes && codes.length){
          const text=codes[0].rawValue;
          const now=Date.now();
          if(text!==lastText || now-lastAt>800){
            lastText=text; lastAt=now; onScan(text);
          }
        }
      }catch{}
      rafId=requestAnimationFrame(tick);
    };
    tick();
  }catch(e){
    setScanStatus(mapMediaError(e),true);
  }
}

async function stopScan(){
  scanning=false;
  if(rafId) cancelAnimationFrame(rafId);
  if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch{} stream=null; }
  document.getElementById("reader").innerHTML='<span class="text-sm">Klik “Mulai Scan” untuk menyalakan kamera</span>';
  setScanStatus("Kamera berhenti.");
}

function mapMediaError(e){
  const n=e?.name||"";
  if(n==="NotAllowedError") return "Akses kamera ditolak (Allow di site settings).";
  if(n==="NotFoundError") return "Kamera tidak ditemukan.";
  if(n==="NotReadableError") return "Kamera dipakai app lain (tutup Zoom/WA/Teams).";
  if(n==="OverconstrainedError") return "Constraint tidak cocok (pilih kamera lain).";
  if(n==="SecurityError") return "Origin tidak aman (pakai HTTPS/localhost).";
  return `Gagal akses kamera: ${n||e}`;
}

async function testCameraBasic(){
  if(!IS_SECURE){ alert("Bukan HTTPS/localhost."); return; }
  try{
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:false});
    s.getTracks().forEach(t=>t.stop());
    alert("Kamera OK & izin diberikan.");
  }catch(e){ alert("Gagal akses kamera: "+(e.name||e)); }
}

async function scanImageFile(file){
  try{
    if(!("BarcodeDetector" in window)){ setScanStatus("Device tidak mendukung scan file tanpa library eksternal.",true); return; }
    const bmp = await createImageBitmap(file);
    // gunakan format minimal QR agar andal
    let fmts=['qr_code']; 
    try{ const sup=await BarcodeDetector.getSupportedFormats(); fmts=fmts.filter(f=>sup.includes(f)); }catch{}
    const det=new BarcodeDetector({formats:fmts.length?fmts:['qr_code']});
    const res=await det.detect(bmp);
    if(res && res.length){ onScan(res[0].rawValue); setScanStatus("Gambar terdeteksi."); }
    else setScanStatus("Tidak terdeteksi dari gambar.",true);
  }catch{ setScanStatus("Gagal decode gambar.",true); }
}

function onScan(raw){
  beepOK();
  document.getElementById("lastResult").textContent=raw;
  const p=parseScanned(raw);
  document.getElementById("barcodeValue").value=p.token||raw;
  if(p.name)  document.getElementById("nama").value=p.name;
  if(p.nomor) document.getElementById("nomorTamu").value=p.nomor;
  setStatus("Kode terdeteksi. Klik Simpan/Perbarui atau Tandai Hadir.",false);
}

/* ================== Form Panitia ================== */
function setStatus(msg,isErr=false){ const el=document.getElementById("statusMsg"); el.textContent=msg; el.className="text-sm "+(isErr?"text-rose-600":"text-slate-500"); }
async function handleSave(markPresent=false){
  const barcode=(document.getElementById("barcodeValue").value||"").trim();
  const nama=(document.getElementById("nama").value||"").trim();
  const nomor=(document.getElementById("nomorTamu").value||"").trim();
  const telp=(document.getElementById("telp").value||"").trim();
  const catatan=(document.getElementById("catatan").value||"").trim();
  if(!barcode){ setStatus("Token wajib diisi (scan/RSVP dulu).",true); return; }

  const exists=await findByBarcode(barcode);
  if(exists.length>0){
    const row=exists[0];
    row.nama=nama||row.nama; row.nomor=nomor||row.nomor; row.telp=telp||row.telp; row.catatan=catatan||row.catatan;
    if(markPresent){ row.hadir=true; row.waktuHadir=new Date().toISOString(); }
    await putEntry(row); setStatus(`Data diperbarui${markPresent?" & ditandai hadir":""}.`);
  }else{
    const entry={ waktu:new Date().toISOString(), barcode, nama, nomor, telp, catatan, hadir:!!markPresent, waktuHadir: markPresent? new Date().toISOString(): null, remoteStatus:"" };
    await addEntry(entry); setStatus("Data tersimpan.");
  }
  refreshTable();
}

/* ================== RSVP Submit ================== */
document.getElementById("rsvpForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  INVITE_BASE_URL=(document.getElementById("baseUrl").value||"").trim();
  const nama=document.getElementById("rsvpNama").value.trim();
  let nomor=document.getElementById("rsvpNomor").value.trim();
  const telp=document.getElementById("rsvpTelp").value.trim();
  const catat=document.getElementById("rsvpCatatan").value.trim();
  const auto=document.getElementById("autoNomor").checked;

  if(!nama){ setRSVPStatus("Nama wajib diisi.",true); clearPreview(); return; }
  if(auto || !nomor){ nomor=String(await getNextNomor()); document.getElementById("rsvpNomor").value=nomor; }

  lastToken=buildToken(nama,nomor);
  lastPayload=buildPayload(lastToken,nama,nomor);

  renderQRorBarcode(lastPayload);
  document.getElementById("payloadBox").textContent=lastPayload;
  document.getElementById("tokenBox").textContent=lastToken;
  document.getElementById("nameBox").textContent=nama;
  document.getElementById("numBox").textContent=nomor;

  const exists=await findByBarcode(lastToken);
  if(exists.length===0){
    await addEntry({ waktu:new Date().toISOString(), barcode:lastToken, nama, nomor, telp, catatan:catat, hadir:false, waktuHadir:null, remoteStatus:"" });
    await refreshTable();
  }

  document.getElementById("barcodeValue").value=lastToken;
  document.getElementById("nama").value=nama;
  document.getElementById("nomorTamu").value=nomor;
  document.getElementById("telp").value=telp;
  document.getElementById("catatan").value=catat;

  setRSVPStatus("RSVP tersimpan & QR dibuat. Silakan unduh PNG.",false);
});
function setRSVPStatus(msg,isErr=false){ const el=document.getElementById("rsvpStatus"); el.textContent=msg; el.className="text-sm "+(isErr?"text-rose-600":"text-slate-500"); }
function clearPreview(){ document.getElementById("qrContainer").innerHTML=""; document.getElementById("payloadBox").textContent="—"; document.getElementById("tokenBox").textContent="—"; document.getElementById("nameBox").textContent="—"; document.getElementById("numBox").textContent="—"; document.getElementById("downloadQrBtn").disabled=true; }
document.getElementById("downloadQrBtn").addEventListener("click",()=>downloadCurrentPNG());
document.querySelectorAll('input[name="qrtype"]').forEach(r=>r.addEventListener("change",()=>{ if(lastPayload){ renderQRorBarcode(lastPayload); }}));

/* ================== Bindings ================== */
document.getElementById("startBtn").addEventListener("click", startScan);
document.getElementById("stopBtn").addEventListener("click", stopScan);
document.getElementById("testCamBtn").addEventListener("click", testCameraBasic);
document.getElementById("fileInput").addEventListener("change", e=>{ const f=e.target.files?.[0]; if(f) scanImageFile(f); e.target.value=""; });
document.getElementById("searchInput").addEventListener("input", refreshTable);
document.getElementById("exportCsvBtn").addEventListener("click", async ()=>{ const rows=await getAll(); download(`buku-tamu-${new Date().toISOString().slice(0,10)}.csv`, toCSV(rows)); });
document.getElementById("clearAllBtn").addEventListener("click", async ()=>{ if(!confirm("Yakin hapus semua data lokal?"))return; await clearAll(); await refreshTable(); setStatus("Semua data dihapus."); });
document.getElementById("guestForm").addEventListener("submit", async (e)=>{ e.preventDefault(); await handleSave(false); });
document.getElementById("markPresentBtn").addEventListener("click", async ()=>{ await handleSave(true); });

/* ================== INIT ================== */
(async function init(){ db=await openDB(); await listCameras(); await refreshTable(); })();
</script>
</body>
</html>
